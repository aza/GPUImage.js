
<html>
    <head>
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta http-equiv="expires" content="0">
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/88/three.js"></script>

        <script src="libs/three.FilterDefinitions.js"></script>

        <script src="libs/filters/ColorInvert.js"></script>
        <script src="libs/filters/EdgeDetect.js"></script>
        <script src="libs/filters/ZoomBlur.js"></script>
        <script src="libs/filters/Blends.js"></script>
        <script src="libs/filters/Delay.js"></script>
        <script src="libs/filters/Swirl.js"></script>
        <script src="libs/filters/SphereRefraction.js"></script>
        <script src="libs/filters/Pixelate.js"></script>
        <script src="libs/filters/Math.js"></script>
        <script src="libs/filters/BilateralBlur.js"></script>
        <script src="libs/filters/Color.js"></script>
        <script src="libs/filters/SobelEdgeDetection.js"></script>
        <script src="libs/filters/Glitch.js"></script>
        <script src="libs/filters/Pattern.js"></script>
        <script src="libs/filters/Noise.js"></script>

        <script src="libs/three.FilterChain.js"></script>

        <script type="text/javascript">
            function init() {

                var canvas = document.getElementById('mainCanvas')
                var renderer = new THREE.WebGLRenderer({ canvas: canvas })
                var scene = new THREE.Scene();

                // camera
                // canvas size is 400x300
                var camera = new THREE.OrthographicCamera(-2, 2, 1.5, -1.5, 1, 10);
                camera.position.set(0, 0, 5);
                scene.add(camera);

                var trippy = new THREE.Trippy( renderer, scene, camera )
                var delay = trippy.createFilter( "Delay", {framesToDelay: 5 } )
                var c = trippy.createFilter( "Grow" )
                var delay2 = trippy.createFilter( "RotateColor", {framesToDelay: 0 } )
                var diff = trippy.createFilter( "DifferenceBlend" )
                var add = trippy.createFilter( "DifferenceBlend" )
                var add2 = trippy.createFilter( "DivideBlend" )
                var start = trippy.createFilter("Grow")
                var s = trippy.createFilter("SobelEdgeDetection")
                c.uniforms.a.update = () => Math.sin(Date.now()/5000)/50.0
                start.uniforms.a.update = () => Math.sin(1.0+Date.now()/8000)/50.0

                trippy.addTarget( start )

                start.addTarget( diff )
                diff.addTarget( delay )
                delay.addTarget( c )
                c.addTarget( diff )

                diff.addTarget( delay2 )

                delay2.addTarget( add )
                trippy.addTarget( s )
                s.addTarget( add )
                add.addTarget( add2 )
                trippy.addTarget( add2 )
                add2.addTarget( "screen" )

                // var trippy = new THREE.Trippy( renderer, scene, camera )
                // var delay = trippy.createFilter( "Delay", {framesToDelay: 5 } )
                // var c = trippy.createFilter( "Grow" )
                // var delay2 = trippy.createFilter( "RotateColor", {framesToDelay: 0 } )
                // var diff = trippy.createFilter( "DifferenceBlend" )
                // var add = trippy.createFilter( "DifferenceBlend" )
                // var start = trippy.createFilter("Grow")
                // var s = trippy.createFilter("Mod")
                // c.uniforms.a.update = () => Math.sin(Date.now()/5000)/50.0
                // start.uniforms.a.update = () => Math.sin(1.0+Date.now()/8000)/50.0
                //
                // trippy.addTarget( start )
                //
                // start.addTarget( diff )
                // diff.addTarget( delay )
                // delay.addTarget( c )
                // c.addTarget( diff )
                //
                // diff.addTarget( delay2 )
                //
                // delay2.addTarget( add )
                // trippy.addTarget( s )
                // s.addTarget( add )
                // add.addTarget( "screen" )

                //
                // var trippy = new THREE.Trippy( renderer, scene, camera )
                // var a = trippy.createFilter( "Delay", {framesToDelay: 0} )
                // var b = trippy.createFilter( "SqrtBlend" )
                // var c = trippy.createFilter( "Grow", {framesToDelay: 0 } )
                // var d = trippy.createFilter( "Delay", {framesToDelay: 0 } )
                // // c.uniforms.a.update = () => Math.sin(Date.now()/1000)/50.0
                //
                // trippy.addTarget( a )
                // a.addTarget( b )
                // b.addTarget( c )
                // c.addTarget( d )
                // c.addTarget( b )
                //
                // d.addTarget( "screen" )


                // var trippy = new THREE.Trippy( renderer, scene, camera )
                // var delay = trippy.createFilter( "Delay", {framesToDelay: 15 } )
                // var c = trippy.createFilter( "SphereRefraction", {radius: 0.0} )
                // var delay2 = trippy.createFilter( "Delay", {framesToDelay: 0 } )
                // var diff = trippy.createFilter( "FunBlend2" )
                // var start = trippy.createFilter("RotateColor", {framesToDelay:0})
                //
                // trippy.addTarget( start )
                //
                // start.addTarget( diff )
                // diff.addTarget( delay )
                // delay.addTarget( c )
                // c.addTarget( diff )
                //
                // diff.addTarget( delay2 )
                // delay2.addTarget( "screen" )

                // var f = filterChain.createFilter( "SobelEdgeDetection" )
                // var c = filterChain.createFilter( "RotateColor" )
                // var m = filterChain.createFilter( "SphereRefraction", {radius: 1.2} )
                // var g = filterChain.createFilter( "Glitch" )
                // var diff = filterChain.createFilter( "DifferenceBlend" )
                //
                // filterChain.addTarget( f )
                // f.addTarget( diff )
                // filterChain.addTarget( c )
                // c.addTarget(m)
                // m.addTarget(g)
                // g.addTarget( diff )
                //
                // diff.addTarget( "screen" )

                // filterChain.addTarget( f2 )
                // f2.addTarget( "screen" )

                // if( Math.random() < 0.5 ){
                //
                //   var filterChain = new THREE.FilterChain( renderer, scene, camera )
                //   var f1 = filterChain.createFilter( "RotateColor")
                //   var f2 = filterChain.createFilter( "Delay", {framesToDelay:0} ) // TODO: Fix BilateralBlur
                //   var f4 = filterChain.createFilter( "DifferenceBlend" )
                //   var f5 = filterChain.createFilter( "SobelEdgeDetection" )
                //   var f3 = filterChain.createFilter( "Glitch" )
                //   var mixer = filterChain.createFilter( "MixByThirdColor" )
                //   var delay = filterChain.createFilter( "Delay", {framesToDelay: 0})
                //   //
                //   filterChain.addTarget( f5 )
                //   f5.uniforms.edgeStrength.update = () => 7.0 + 4*Math.sin(Date.now()/1000)
                //
                //   f5.addTarget( f1 )
                //   f1.addTarget( f4 )
                //
                //   filterChain.addTarget( f4 )
                //   f4.addTarget( f2 )
                //
                //   f2.addTarget( f3 )
                //
                //   f3.addTarget( mixer )
                //   f3.addTarget( delay )
                //   delay.addTarget( mixer )
                //   f3.addTarget( mixer )
                //   mixer.addTarget( 'screen' )
                // }
                //
                // else {
                //
                //
                //   var filterChain = new THREE.FilterChain( renderer, scene, camera )
                //   var edge = filterChain.createFilter( "SobelEdgeDetection", {edgeStrength: 3} )
                //   var mixer = filterChain.createFilter( "MixByThirdColor" )
                //   var colorize = filterChain.createFilter( "RotateColor")
                //   var mod = filterChain.createFilter( "Mod")
                //   var noise = filterChain.createFilter( "Noise", {scale: 8, contrast: 0.7})
                //   var mult = filterChain.createFilter( "DivideBlend")
                //
                //   filterChain.addTarget( edge )
                //   edge.addTarget( colorize )
                //   colorize.addTarget( mixer )
                //
                //   filterChain.addTarget( mod )
                //   mod.addTarget( mixer )
                //
                //   noise.uniforms.speed.update = () => { return 1.5 + 0.5+Math.sin(Date.now()/5000.0) }
                //   noise.uniforms.contrast.update = () => { return 3 + 3+Math.sin(Date.now()/1000.0) }
                //
                //   noise.addTarget( mult )
                //   filterChain.addTarget( mult )
                //
                //   mult.addTarget( mixer )
                //   filterChain.addTarget( noise )
                //
                //
                //   mixer.addTarget( 'screen' )
                // }





                // video texture
                var videoImage = document.createElement('canvas');
                videoImage.width = canvas.width;
                videoImage.height = canvas.height;

                var videoImageContext = videoImage.getContext('2d');

                videoTexture = new THREE.Texture(videoImage)
                videoTexture.minFilter = THREE.LinearFilter
                videoTexture.magFilter = THREE.LinearFilter

                var videoMaterial = new THREE.MeshBasicMaterial({
                    map: videoTexture,
                    overdraw: true
                })
                var videoGeometry = new THREE.PlaneBufferGeometry(4, 3)
                var videoMesh = new THREE.Mesh(videoGeometry, videoMaterial)
                videoMesh.position.set(0, 0, 0)
                scene.add(videoMesh)

                // local video
                var video = document.getElementById('video');

                var facingMode = "user";
                var constraints = {
                  audio: false,
                  video: true
                }


                navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                    video.srcObject = stream

                    video.onloadedmetadata = function(e) {
                        videoImage.width = this.videoWidth
                        videoImage.height = this.videoHeight
                        video.play()

                        renderFrame()
                    }
                })

                function renderFrame() {
                    videoImageContext.drawImage(video, 0, 0)
                    if (videoTexture) {
                        videoTexture.needsUpdate = true
                    }

                    trippy.render()
                    // f.uniforms.edgeStrength.value = 3+3*Math.sin( Date.now()/1000.0 )

                    // f3.uniforms['blurSize'].value = (10 + 10.0 * Math.sin( Date.now()/3000.0 )
                    // f3.uniforms['blurCenter'].value = new THREE.Vector2( 0.5+Math.sin( Date.now()/100)/2.0, 0.5+Math.cos( Date.now()/100)/2.0 )
                    requestAnimationFrame(renderFrame)
                }
            }
        </script>
        <style>
          canvas{
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
          }
        </style>
    </head>

    <body onload="init()">
        <canvas id="mainCanvas" width="1200px" height="900px" ></canvas>
        <video id="video" width="1200px" height="900px" autoplay playsinline></video>

        <script>
        (function(){var script=document.createElement('script');script.onload=function(){var stats=new Stats();document.body.appendChild(stats.dom);requestAnimationFrame(function loop(){stats.update();requestAnimationFrame(loop)});};script.src='//rawgit.com/mrdoob/stats.js/master/build/stats.min.js';document.head.appendChild(script);})()

        </script>
    </body>
</html>
